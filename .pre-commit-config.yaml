# Pre-commit configuration for VjMapper
# Runs automatically via pre-commit.ci on every PR

ci:
  autofix_commit_msg: "style: auto-fix by pre-commit.ci [skip ci]"
  autofix_prs: true
  autoupdate_branch: ""
  autoupdate_commit_msg: "chore: pre-commit autoupdate [skip ci]"
  autoupdate_schedule: weekly
  
  # Skip hooks that don't work in CI or are too strict
  skip:
    - fmt
    - clippy
    - cargo-sort
    - markdownlint-fix
    - detect-secrets
  
  submodules: false

repos:
  # ═══════════════════════════════════════════════════════════════
  # RUST FORMATTING & LINTING (local only - requires toolchain)
  # ═══════════════════════════════════════════════════════════════
  - repo: https://github.com/doublify/pre-commit-rust
    rev: v1.0
    hooks:
      - id: fmt
        name: "Rust: cargo fmt"
        args: ['--all', '--']
        stages: [manual]
        
      - id: clippy
        name: "Rust: cargo clippy"
        args:
          - '--workspace'
          - '--all-targets'
          - '--'
          - '-D'
          - 'warnings'
        stages: [manual]

  # ═══════════════════════════════════════════════════════════════
  # GENERAL FILE FIXES (runs in CI - fast & reliable)
  # ═══════════════════════════════════════════════════════════════
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # Auto-fix trailing whitespace
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^(.*\.patch|.*\.diff)$
        
      # Auto-fix missing final newline
      - id: end-of-file-fixer
        exclude: ^(.*\.patch|.*\.diff|.*\.rs\.bk)$
        
      # Check for filename case conflicts
      - id: check-case-conflict
        
      # Validate YAML syntax
      - id: check-yaml
        args: [--allow-multiple-documents]
        
      # Validate TOML syntax
      - id: check-toml
        
      # Prevent huge files
      - id: check-added-large-files
        args: [--maxkb=5000]
        exclude: ^(.*\.dll|.*\.so|.*\.dylib|assets/.*|resources/.*)$
        
      # Check for merge conflict markers
      - id: check-merge-conflict
        
      # Fix line endings (LF for Unix)
      - id: mixed-line-ending
        args: [--fix=lf]
        exclude: ^(.*\.bat|.*\.cmd)$  # Keep CRLF for Windows scripts

  # ═══════════════════════════════════════════════════════════════
  # MARKDOWN LINTING (local only - too many legacy violations)
  # ═══════════════════════════════════════════════════════════════
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.39.0
    hooks:
      - id: markdownlint-fix
        name: "Markdown: lint and fix"
        args:
          - '--config'
          - '.markdownlint.json'
        files: \.(md|markdown)$
        exclude: ^(CHANGELOG\.md|.*\.patch)$
        stages: [manual]  # Run manually only

  # ═══════════════════════════════════════════════════════════════
  # SECURITY: SECRET DETECTION (local only - needs baseline setup)
  # ═══════════════════════════════════════════════════════════════
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        name: "Security: detect secrets"
        args:
          - '--baseline'
          - '.secrets.baseline'
        exclude: ^(Cargo\.lock|.*\.patch|.*\.diff)$
        stages: [manual]  # Run manually only

  # ═══════════════════════════════════════════════════════════════
  # CARGO.TOML SORTING (local only - requires cargo-sort binary)
  # ═══════════════════════════════════════════════════════════════
  - repo: https://github.com/DevinR528/cargo-sort
    rev: v1.0.9
    hooks:
      - id: cargo-sort
        name: "Rust: sort Cargo.toml"
        args: ['--workspace', '--grouped']
        stages: [manual]
