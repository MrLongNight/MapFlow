name: "CI-04: Session Trigger"

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to trigger Jules session for'
        required: false
        type: string

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  trigger-jules-session:
    name: Create Jules Session
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' &&
       ((github.event.action == 'labeled' && github.event.label.name == 'jules-task') ||
        (github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'jules-task')))) ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get issue details
        id: get-issue
        uses: actions/github-script@v7
        with:
          script: |
            // Determine issue number (workflow_dispatch input has priority)
            let issueNumber;
            if (context.eventName === 'workflow_dispatch' && context.payload.inputs && context.payload.inputs.issue_number) {
              issueNumber = parseInt(context.payload.inputs.issue_number, 10);
            } else if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            }

            if (!issueNumber) {
              core.info('âš ï¸ No issue number found in workflow context â€” nothing to do.');
              core.setOutput('has_issue', 'false');
              return;
            }

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const hasJulesLabel = (issue.labels || []).some(l => (typeof l === 'string' ? l : l.name) === 'jules-task');
            if (!hasJulesLabel) {
              core.info(`â­ï¸ Issue #${issueNumber} does not have label 'jules-task' â€” skipping.`);
              core.setOutput('has_issue', 'false');
              return;
            }

            if (issue.state === 'closed') {
              core.info(`â­ï¸ Issue #${issueNumber} is closed â€” skipping.`);
              core.setOutput('has_issue', 'false');
              return;
            }

            core.info(`ğŸ¯ Processing Issue #${issueNumber}: ${issue.title}`);
            core.setOutput('has_issue', 'true');
            core.setOutput('issue_number', issueNumber.toString());
            core.setOutput('issue_title', issue.title || '');
            core.setOutput('issue_body', issue.body || '');

            // Inform the issue that a Jules session is being started
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ğŸ¤– **Jules Session Triggered**\n\nA Jules session is being created for this issue.\n\n*Triggered by: ${context.workflow} workflow*`
            });

      - name: Check Jules API secrets
        id: check-secrets
        if: steps.get-issue.outputs.has_issue == 'true'
        run: |
          has_api_url=false
          has_api_key=false

          if [ -n "${{ secrets.JULES_API_URL }}" ]; then
            has_api_url=true
            echo "âœ… JULES_API_URL is configured"
          else
            echo "âš ï¸ JULES_API_URL secret is not configured"
          fi

          if [ -n "${{ secrets.JULES_API_KEY }}" ]; then
            has_api_key=true
            echo "âœ… JULES_API_KEY is configured"
          else
            echo "âš ï¸ JULES_API_KEY secret is not configured"
          fi

          echo "has_api_url=${has_api_url}" >> $GITHUB_OUTPUT
          echo "has_api_key=${has_api_key}" >> $GITHUB_OUTPUT

      - name: Create Jules session via HTTP API
        id: create-session
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-secrets.outputs.has_api_url == 'true' && steps.check-secrets.outputs.has_api_key == 'true'
        uses: actions/github-script@v7
        env:
          JULES_API_URL: ${{ secrets.JULES_API_URL }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            const title = `${context.repo.owner}/${context.repo.repo}#${issueNumber} â€” ${'${{ steps.get-issue.outputs.issue_title }}'}`.slice(0, 240);
            const body = `${'${{ steps.get-issue.outputs.issue_body }}'}`.slice(0, 5000);

            if (!process.env.JULES_API_URL || !process.env.JULES_API_KEY) {
              throw new Error('Missing JULES_API_URL or JULES_API_KEY environment variable.');
            }

            const endpoint = `${process.env.JULES_API_URL.replace(/\/+$/, '')}/sessions`;

            core.info(`POST ${endpoint}  â†’ creating session for issue #${issueNumber}`);

            const payload = {
              metadata: {
                repository: `${context.repo.owner}/${context.repo.repo}`,
                issue_number: issueNumber,
                issue_title: title
              },
              prompt: `Issue #${issueNumber}: ${title}\n\n${body}`
            };

            const res = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.JULES_API_KEY}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(payload)
            });

            if (!res.ok) {
              const txt = await res.text().catch(()=>'<no body>');
              core.error(`Jules API returned ${res.status}: ${txt}`);
              // create a comment on the issue describing failure
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âš ï¸ **Jules Session Creation Failed**\n\nJules API returned status ${res.status}. See workflow logs for details.`
              });
              // fail the step so the failure branch can run if desired
              throw new Error(`Jules API error: ${res.status} - ${txt}`);
            }

            const json = await res.json().catch(()=>null);
            core.info('Jules API response: ' + JSON.stringify(json));

            const sessionId = json?.id ?? json?.session_id ?? null;
            const sessionUrl = json?.url ?? json?.session_url ?? null;

            // Comment success info back to the issue
            let successBody = `âœ… **Jules Session Created Successfully**\n\nJules has been requested to work on this issue.`;
            if (sessionId) successBody += `\n\nSession ID: \`${sessionId}\``;
            if (sessionUrl) successBody += `\n\nOpen session: ${sessionUrl}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: successBody
            });

            core.setOutput('session_id', sessionId ?? '');
            core.setOutput('session_url', sessionUrl ?? '');

      - name: Inform about missing Jules integration / fallback
        if: steps.get-issue.outputs.has_issue == 'true' && (steps.check-secrets.outputs.has_api_key == 'false' || steps.check-secrets.outputs.has_api_url == 'false')
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âš ï¸ **Jules integration not configured**\n\nThis repository does not have the Jules API secrets set. To enable automated Jules sessions, add the following repository secrets:\n\n- \`JULES_API_URL\` â€” Jules API base URL (e.g. https://jules.example/api)\n- \`JULES_API_KEY\` â€” Jules API key\n\nAlternatively, install the Jules GitHub App: https://github.com/apps/jules`
            });

      - name: Log completion
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ CI-04: Session Trigger completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [ "${{ steps.get-issue.outputs.has_issue }}" != "true" ]; then
            echo "â­ï¸ No applicable issue or issue does not have 'jules-task' label."
          else
            if [ "${{ steps.check-secrets.outputs.has_api_url }}" = "true" ] && [ "${{ steps.check-secrets.outputs.has_api_key }}" = "true" ]; then
              echo "âœ… Jules API call attempted. Check job logs for details."
            else
              echo "âš ï¸ Jules integration not fully configured (missing JULES_API_URL or JULES_API_KEY)."
              echo "â†’ Consider installing the Jules GitHub App: https://github.com/apps/jules"
            fi
          fi
          echo ""
