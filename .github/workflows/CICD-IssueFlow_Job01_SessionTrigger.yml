name: "CICD-IssueFlow: Job01 SessionTrigger"

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue Number'
        required: false
        type: string

permissions:
  issues: write
  contents: write
  pull-requests: write
  actions: write

env:
  JULES_AUTOMATION_ENABLED: true

jobs:
  trigger-session:
    name: Start Jules Session
    runs-on: ubuntu-latest
    if: github.event.label.name == 'jules-task' || contains(github.event.issue.labels.*.name, 'jules-task') || github.event_name == 'workflow_dispatch'
    
    concurrency:
      group: issue-flow-session-${{ github.repository }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
      
      - name: Execute Trigger Logic
        id: flow
        uses: actions/github-script@v7
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          script: |
             if (process.env.JULES_AUTOMATION_ENABLED !== 'true') return;

             const issueNumber = context.payload.issue?.number || context.payload.inputs?.issue_number;
             if (!issueNumber) { console.log("No issue identified."); return; }

             console.log(`üéØ Processing Issue #${issueNumber}`);

             // 1. Helper: Check if session exists (Parsing comments)
             const comments = await github.rest.issues.listComments({
               owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber
             });
             const hasSession = comments.data.some(c => c.body.includes('Jules Session Triggered') || c.body.includes('Jules session created'));
             if (hasSession) {
               console.log("Session already exists.");
               return;
             }

             // 2. Validate Key
             if (!process.env.JULES_API_KEY) {
               await github.rest.issues.createComment({
                 owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber,
                 body: "‚ö†Ô∏è JULES_API_KEY missing. Cannot start session."
               });
               return;
             }

             // 3. Create Session
             const fetch = globalThis.fetch ?? (await import('node-fetch')).default;
             const issue = await github.rest.issues.get({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber });
             
             const endpoint = 'https://jules.googleapis.com/v1alpha/sessions';
             const payload = {
               prompt: `Issue #${issueNumber}: ${issue.data.title}\n\n${issue.data.body || ''}`,
               title: `Issue #${issueNumber}: ${issue.data.title}`.substring(0, 100),
               automationMode: 'AUTO_CREATE_PR',
               sourceContext: {
                 source: `sources/github/${context.repo.owner}/${context.repo.repo}`,
                 githubRepoContext: { startingBranch: 'main' }
               }
             };

             console.log("Sending API Request to Jules...");
             const res = await fetch(endpoint, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': process.env.JULES_API_KEY },
               body: JSON.stringify(payload)
             });

             if (!res.ok) {
               const txt = await res.text();
               console.error(`Status ${res.status}: ${txt}`);
               await github.rest.issues.createComment({
                 owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber,
                 body: `‚ö†Ô∏è Jules API Error: ${res.status}`
               });
               throw new Error("API Failed");
             }

             const json = await res.json();
             const sessionUrl = json.url || '';
             const sessionId = json.name || json.id;

             console.log(`‚úÖ Session created: ${sessionId}`);
             await github.rest.issues.createComment({
                 owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber,
                 body: `ü§ñ **Jules Session Triggered** ‚Äî [Open Session](${sessionUrl})`
             });

             // 4. Trigger Monitor
             try {
               await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'CICD-IssueFlow_Job02_SessionMonitor.yml',
                  ref: 'main',
                  inputs: {
                    issue_number: String(issueNumber),
                    session_id: sessionId
                  }
               });
               console.log("Triggered Monitor Workflow.");
             } catch (e) {
               console.error("Failed to trigger monitor: " + e.message);
             }
