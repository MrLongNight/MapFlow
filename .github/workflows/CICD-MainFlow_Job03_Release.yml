name: "Stable Release"

# ═══════════════════════════════════════════════════════════════
# WICHTIG: Dieser Workflow erstellt produktionsreife Releases.
# Er generiert MSI-Installer und ZIP-Archive für Windows sowie
# Tarballs für Linux.
#
# FIX 2026-02-20: Windows-Build korrigiert – ffmpeg-sys-next
# suchte nach Linux-Headern (/usr/include/libavcodec/avfft.h)
# auf Windows. Lösung: FFMPEG_DIR + pkg-config korrekt setzen,
# damit bindgen die vcpkg-Header findet.
# ═══════════════════════════════════════════════════════════════

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. v1.0.0)'
        required: true
      is_prerelease:
        description: 'Mark as Pre-release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # ═══════════════════════════════════════════════════════════════
  # BUILD WINDOWS (MSI & ZIP)
  # ═══════════════════════════════════════════════════════════════
  build-windows:
    name: "Build (Windows x64)"
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: vcpkg installieren
        shell: pwsh
        run: |
          if (-not (Test-Path "vcpkg")) {
            git clone https://github.com/microsoft/vcpkg.git
            .\vcpkg\bootstrap-vcpkg.bat
          }
          .\vcpkg\vcpkg integrate install

      - name: VCPKG_ROOT-Variable setzen
        shell: pwsh
        run: |
          $vcpkgRoot = "$(Get-Location)\vcpkg"
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" >> $env:GITHUB_ENV

      - name: ffmpeg mit vcpkg installieren
        shell: pwsh
        run: .\vcpkg\vcpkg install ffmpeg:x64-windows

      # ═══════════════════════════════════════════════════════════════
      # LLVM/Clang für bindgen installieren
      # ═══════════════════════════════════════════════════════════════
      - name: Install LLVM and Clang
        shell: pwsh
        run: |
          choco install llvm --version=18.1.8 -y
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      # ═══════════════════════════════════════════════════════════════
      # pkg-config für Windows installieren (benötigt für ffmpeg-sys-next)
      # ═══════════════════════════════════════════════════════════════
      - name: Install pkg-config for Windows
        shell: pwsh
        run: |
          choco install pkgconfiglite -y
          echo "C:\ProgramData\chocolatey\bin" >> $env:GITHUB_PATH

      # ═══════════════════════════════════════════════════════════════
      # FFmpeg-Pfade korrekt für bindgen und ffmpeg-sys-next setzen
      #
      # KRITISCH: FFMPEG_DIR wird von ffmpeg-sys-next als primäre
      # Quelle für Header und Libs verwendet. Ohne diese Variable
      # fällt das Build-Script auf Linux-Pfade zurück und sucht
      # nach /usr/include/libavcodec/avfft.h – was auf Windows
      # nicht existiert.
      # ═══════════════════════════════════════════════════════════════
      - name: Set FFmpeg paths for bindgen and ffmpeg-sys-next
        shell: pwsh
        run: |
          $VcpkgRoot = "$(Get-Location)\vcpkg"
          $InstalledDir = "$VcpkgRoot\installed\x64-windows"
          $IncludePath = "$InstalledDir\include"
          $LibPath = "$InstalledDir\lib"
          $BinPath = "$InstalledDir\bin"

          # FFMPEG_DIR ist die primäre Variable für ffmpeg-sys-next
          # Sie verhindert, dass das Build-Script Linux-Fallback-Pfade nutzt
          echo "FFMPEG_DIR=$InstalledDir" >> $env:GITHUB_ENV

          # Explizite Include/Lib-Pfade als Fallback
          echo "FFMPEG_INCLUDE_DIR=$IncludePath" >> $env:GITHUB_ENV
          echo "FFMPEG_LIB_DIR=$LibPath" >> $env:GITHUB_ENV

          # pkg-config muss die .pc-Dateien von vcpkg finden
          echo "PKG_CONFIG_PATH=$LibPath\pkgconfig" >> $env:GITHUB_ENV

          # Bindgen muss die vcpkg-Header finden, NICHT /usr/include
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I$IncludePath" >> $env:GITHUB_ENV

          # DLL-Pfad für Runtime
          echo "$BinPath" >> $env:GITHUB_PATH

          # Diagnose-Ausgabe
          Write-Host "=== FFmpeg Environment Setup ==="
          Write-Host "FFMPEG_DIR=$InstalledDir"
          Write-Host "FFMPEG_INCLUDE_DIR=$IncludePath"
          Write-Host "FFMPEG_LIB_DIR=$LibPath"
          Write-Host "PKG_CONFIG_PATH=$LibPath\pkgconfig"
          Write-Host "BINDGEN_EXTRA_CLANG_ARGS=-I$IncludePath"

          # Verifiziere, dass die Header tatsächlich existieren
          if (Test-Path "$IncludePath\libavcodec\avcodec.h") {
              Write-Host "✅ FFmpeg headers found at $IncludePath"
          } else {
              Write-Error "❌ FFmpeg headers NOT found at $IncludePath"
              Get-ChildItem $InstalledDir -Recurse -Filter "avcodec.h" | ForEach-Object { Write-Host "Found: $($_.FullName)" }
              exit 1
          }

          # Verifiziere, dass .lib-Dateien existieren
          if (Test-Path "$LibPath\avcodec.lib") {
              Write-Host "✅ FFmpeg libs found at $LibPath"
          } else {
              Write-Error "❌ FFmpeg libs NOT found at $LibPath"
              Get-ChildItem $InstalledDir -Recurse -Filter "avcodec.lib" | ForEach-Object { Write-Host "Found: $($_.FullName)" }
              exit 1
          }

      - name: Install WiX Toolset
        run: dotnet tool install --global WiX

      - name: Install cargo-wix
        run: cargo install cargo-wix

      - name: Build (Release)
        shell: pwsh
        run: |
          # Nochmal sicherstellen, dass die Env-Variablen gesetzt sind
          Write-Host "FFMPEG_DIR=$env:FFMPEG_DIR"
          Write-Host "LIBCLANG_PATH=$env:LIBCLANG_PATH"
          Write-Host "PKG_CONFIG_PATH=$env:PKG_CONFIG_PATH"
          cargo build --release --verbose --features "audio,ffmpeg"

      - name: Prepare Release Folder & Copy DLLs
        shell: pwsh
        run: |
          $ReleaseDir = "target/release"
          $VcpkgBin = "vcpkg/installed/x64-windows/bin"

          if (Test-Path $VcpkgBin) {
              Write-Host "Copying DLLs from $VcpkgBin to $ReleaseDir..."
              $DllCount = (Get-ChildItem "$VcpkgBin/*.dll").Count
              Copy-Item "$VcpkgBin/*.dll" "$ReleaseDir/" -Force
              Write-Host "✅ Copied $DllCount DLLs"
          } else {
              Write-Error "❌ Vcpkg bin directory not found at $VcpkgBin!"
              exit 1
          }

      - name: Create ZIP Artifact
        shell: pwsh
        run: |
          $Version = "${{ inputs.version }}"
          $ZipName = "MapFlow-$Version-Windows-x64.zip"
          Compress-Archive -Path "target/release/MapFlow.exe", "target/release/*.dll" -DestinationPath "$ZipName"
          echo "ZIP_PATH=$ZipName" >> $env:GITHUB_ENV

      - name: Build MSI Installer
        shell: pwsh
        run: |
          # Use cargo wix to build the MSI
          cargo wix --release --no-check-includes
          $MsiPath = Get-ChildItem -Path "target/wix/*.msi" | Select-Object -First 1 -ExpandProperty FullName
          Move-Item -Path $MsiPath -Destination "MapFlow-${{ inputs.version }}-x64.msi"
          echo "MSI_PATH=MapFlow-${{ inputs.version }}-x64.msi" >> $env:GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            MapFlow-${{ inputs.version }}-Windows-x64.zip
            MapFlow-${{ inputs.version }}-x64.msi

  # ═══════════════════════════════════════════════════════════════
  # BUILD LINUX (TAR.GZ)
  # ═══════════════════════════════════════════════════════════════
  build-linux:
    name: "Build (Linux x64)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install System Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential pkg-config clang libclang-dev \
            libasound2-dev libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libavdevice-dev libavfilter-dev libswresample-dev \
            ffmpeg

      - name: Build (Release)
        run: cargo build --release --verbose --features "ffmpeg"

      - name: Create Tarball
        run: |
          VERSION="${{ inputs.version }}"
          TAR_NAME="MapFlow-$VERSION-Linux-x64.tar.gz"
          cd target/release
          tar -czf "../../$TAR_NAME" MapFlow
          echo "TAR_PATH=$TAR_NAME" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: MapFlow-${{ inputs.version }}-Linux-x64.tar.gz

  # ═══════════════════════════════════════════════════════════════
  # CREATE GITHUB RELEASE
  # ═══════════════════════════════════════════════════════════════
  publish-release:
    name: "Publish Release"
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ inputs.is_prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "${{ inputs.version }}" \
            --title "MapFlow ${{ inputs.version }}" \
            --generate-notes \
            $PRERELEASE_FLAG \
            MapFlow-${{ inputs.version }}-Windows-x64.zip \
            MapFlow-${{ inputs.version }}-x64.msi \
            MapFlow-${{ inputs.version }}-Linux-x64.tar.gz
