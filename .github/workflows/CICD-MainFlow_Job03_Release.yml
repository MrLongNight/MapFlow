name: "CICD-MainFlow: Job03 Release"

# ═══════════════════════════════════════════════════════════════
# WICHTIG: Dieser Workflow erstellt produktionsreife Releases.
# Er generiert MSI-Installer und ZIP-Archive für Windows sowie
# Tarballs für Linux.
# ═══════════════════════════════════════════════════════════════

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. v1.0.0)'
        required: true
      is_prerelease:
        description: 'Mark as Pre-release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # ═══════════════════════════════════════════════════════════════
  # BUILD WINDOWS (MSI & ZIP)
  # ═══════════════════════════════════════════════════════════════
  build-windows:
    name: "Build (Windows x64)"
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: vcpkg installieren
        shell: bash
        run: |
          if [ ! -d "vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git
            ./vcpkg/bootstrap-vcpkg.sh
          fi
          ./vcpkg/vcpkg integrate install

      - name: ffmpeg mit vcpkg installieren
        shell: bash
        run: ./vcpkg/vcpkg install ffmpeg:x64-windows

      - name: VCPKG_ROOT-Variable setzen
        shell: bash
        run: echo "VCPKG_ROOT=$(pwd)/vcpkg" >> $GITHUB_ENV

      # ═══════════════════════════════════════════════════════════════
      # NEU: LLVM/Clang für bindgen installieren
      # ═══════════════════════════════════════════════════════════════
      - name: Install LLVM and Clang
        shell: pwsh
        run: |
          choco install llvm --version=18.1.8 -y
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      # ═══════════════════════════════════════════════════════════════
      # NEU: FFmpeg Include-Pfade für bindgen setzen
      # ═══════════════════════════════════════════════════════════════
      - name: Set FFmpeg paths for bindgen
        shell: pwsh
        run: |
          $VcpkgRoot = "$(Get-Location)\vcpkg"
          $IncludePath = "$VcpkgRoot\installed\x64-windows\include"
          $LibPath = "$VcpkgRoot\installed\x64-windows\lib"

          echo "FFMPEG_INCLUDE_DIR=$IncludePath" >> $env:GITHUB_ENV
          echo "FFMPEG_LIB_DIR=$LibPath" >> $env:GITHUB_ENV
          echo "BINDGEN_EXTRA_ClANG_ARGS=-I$IncludePath" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=$LibPath\pkgconfig" >> $env:GITHUB_ENV

      - name: Install WiX Toolset
        run: dotnet tool install --global WiX

      - name: Install cargo-wix
        run: cargo install cargo-wix

      - name: Build (Release)
        run: cargo build --release --verbose --features "audio,ffmpeg"

      - name: Prepare Release Folder & Copy DLLs
        shell: pwsh
        run: |
          $ReleaseDir = "target/release"
          $VcpkgBin = "vcpkg_installed/x64-windows/bin"
          if (-not (Test-Path $VcpkgBin)) { $VcpkgBin = "vcpkg/installed/x64-windows/bin" }

          if (Test-Path $VcpkgBin) {
              Write-Host "Copying DLLs from $VcpkgBin to $ReleaseDir..."
              Copy-Item "$VcpkgBin/*.dll" "$ReleaseDir/" -Force
          } else {
              Write-Warning "Vcpkg bin directory not found!"
          }

      - name: Create ZIP Artifact
        shell: pwsh
        run: |
          $Version = "${{ inputs.version }}"
          $ZipName = "MapFlow-$Version-Windows-x64.zip"
          Compress-Archive -Path "target/release/MapFlow.exe", "target/release/*.dll" -DestinationPath "$ZipName"
          echo "ZIP_PATH=$ZipName" >> $env:GITHUB_ENV

      - name: Build MSI Installer
        shell: pwsh
        run: |
          # Use cargo wix to build the MSI
          # Note: version in Cargo.toml should ideally match, but we can override
          cargo wix --release --no-check-includes
          $MsiPath = Get-ChildItem -Path "target/wix/*.msi" | Select-Object -First 1 -ExpandProperty FullName
          Move-Item -Path $MsiPath -Destination "MapFlow-${{ inputs.version }}-x64.msi"
          echo "MSI_PATH=MapFlow-${{ inputs.version }}-x64.msi" >> $env:GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            MapFlow-${{ inputs.version }}-Windows-x64.zip
            MapFlow-${{ inputs.version }}-x64.msi

  # ═══════════════════════════════════════════════════════════════
  # BUILD LINUX (TAR.GZ)
  # ═══════════════════════════════════════════════════════════════
  build-linux:
    name: "Build (Linux x64)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install System Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential pkg-config clang libclang-dev \
            libasound2-dev libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libavdevice-dev libavfilter-dev libswresample-dev \
            ffmpeg

      - name: Build (Release)
        run: cargo build --release --verbose --features "ffmpeg"

      - name: Create Tarball
        run: |
          VERSION="${{ inputs.version }}"
          TAR_NAME="MapFlow-$VERSION-Linux-x64.tar.gz"
          cd target/release
          tar -czf "../../$TAR_NAME" MapFlow
          echo "TAR_PATH=$TAR_NAME" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: MapFlow-${{ inputs.version }}-Linux-x64.tar.gz

  # ═══════════════════════════════════════════════════════════════
  # CREATE GITHUB RELEASE
  # ═══════════════════════════════════════════════════════════════
  publish-release:
    name: "Publish Release"
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ inputs.is_prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "${{ inputs.version }}" \
            --title "MapFlow ${{ inputs.version }}" \
            --generate-notes \
            $PRERELEASE_FLAG \
            MapFlow-${{ inputs.version }}-Windows-x64.zip \
            MapFlow-${{ inputs.version }}-x64.msi \
            MapFlow-${{ inputs.version }}-Linux-x64.tar.gz
