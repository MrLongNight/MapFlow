name: "Stable Release"

# ═══════════════════════════════════════════════════════════════
# WICHTIG: Dieser Workflow erstellt produktionsreife Releases.
# Er generiert MSI-Installer und ZIP-Archive für Windows sowie
# Tarballs für Linux.
#
# FIX 2026-02-21:
# - Windows: pkg-config & FFmpeg Pfade für ffmpeg-sys-next stabilisiert.
# - Linux: Fehlende Grafik- & Audio-Abhängigkeiten hinzugefügt.
# - Workspace: Explizite Paket-Selektion (-p mapmap) für Binaries.
# ═══════════════════════════════════════════════════════════════

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. v1.0.0)'
        required: true
      is_prerelease:
        description: 'Mark as Pre-release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # ═══════════════════════════════════════════════════════════════
  # BUILD WINDOWS (MSI & ZIP)
  # ═══════════════════════════════════════════════════════════════
  build-windows:
    name: "Build (Windows x64)"
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: vcpkg installieren
        shell: pwsh
        run: |
          if (-not (Test-Path "vcpkg")) {
            git clone https://github.com/microsoft/vcpkg.git
            .\vcpkg\bootstrap-vcpkg.bat
          }
          .\vcpkg\vcpkg integrate install

      - name: VCPKG_ROOT-Variable setzen
        shell: pwsh
        run: |
          $vcpkgRoot = "$(Get-Location)\vcpkg"
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" >> $env:GITHUB_ENV

      - name: ffmpeg mit vcpkg installieren
        shell: pwsh
        run: .\vcpkg\vcpkg install ffmpeg:x64-windows

      - name: Install LLVM and Clang
        shell: pwsh
        run: |
          choco install llvm --version=18.1.8 -y --allow-downgrade --force
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      - name: Install pkg-config for Windows
        shell: pwsh
        run: |
          choco install pkgconfiglite -y
          echo "C:\ProgramData\chocolatey\bin" >> $env:GITHUB_PATH

      - name: Set FFmpeg environment for ffmpeg-sys-next
        shell: pwsh
        run: |
          $VcpkgRoot = "$(Get-Location)\vcpkg"
          $InstalledDir = "$VcpkgRoot\installed\x64-windows"
          $IncludePath = "$InstalledDir\include"
          $LibPath = "$InstalledDir\lib"
          $BinPath = "$InstalledDir\bin"
          $PkgConfigPath = "$LibPath\pkgconfig"

          echo "FFMPEG_PKG_CONFIG_PATH=$PkgConfigPath" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=$PkgConfigPath" >> $env:GITHUB_ENV
          echo "INCLUDE=$IncludePath" >> $env:GITHUB_ENV
          echo "FFMPEG_DIR=$InstalledDir" >> $env:GITHUB_ENV
          echo "FFMPEG_INCLUDE_DIR=$IncludePath" >> $env:GITHUB_ENV
          echo "FFMPEG_LIB_DIR=$LibPath" >> $env:GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I$IncludePath" >> $env:GITHUB_ENV
          echo "LIB=$LibPath" >> $env:GITHUB_ENV
          echo "$BinPath" >> $env:GITHUB_PATH

      - name: Verify FFmpeg environment
        shell: pwsh
        run: |
          $VcpkgRoot = "$(Get-Location)\vcpkg"
          $InstalledDir = "$VcpkgRoot\installed\x64-windows"
          $IncludePath = "$InstalledDir\include"
          $LibPath = "$InstalledDir\lib"
          $PkgConfigPath = "$LibPath\pkgconfig"

          $criticalHeaders = @("libavcodec/avcodec.h", "libavformat/avformat.h", "libavutil/avutil.h", "libswscale/swscale.h")
          foreach ($header in $criticalHeaders) {
            if (-not (Test-Path (Join-Path $IncludePath $header))) { throw "Missing $header" }
          }

          $env:PKG_CONFIG_PATH = $PkgConfigPath
          & pkg-config --cflags libavcodec

          $libs = @("avcodec.lib", "avformat.lib", "avutil.lib", "swscale.lib")
          foreach ($lib in $libs) {
            if (-not (Test-Path (Join-Path $LibPath $lib))) { throw "Missing $lib" }
          }

      - name: Install WiX Toolset
        run: dotnet tool install --global WiX

      - name: Install cargo-wix
        run: cargo install cargo-wix

      - name: Build (Release)
        shell: pwsh
        run: cargo build --release -p mapmap --features "audio,ffmpeg"

      - name: Prepare Release Folder & Copy DLLs
        shell: pwsh
        run: |
          $ReleaseDir = "target/release"
          $VcpkgBin = "vcpkg/installed/x64-windows/bin"
          Copy-Item "$VcpkgBin/*.dll" "$ReleaseDir/" -Force

      - name: Create ZIP Artifact
        shell: pwsh
        run: |
          $Version = "${{ inputs.version }}"
          $ZipName = "MapFlow-$Version-Windows-x64.zip"
          Compress-Archive -Path "target/release/MapFlow.exe", "target/release/*.dll" -DestinationPath "$ZipName"
          echo "ZIP_PATH=$ZipName" >> $env:GITHUB_ENV

      - name: Build MSI Installer
        shell: pwsh
        run: |
          # Führe cargo wix im Root aus, aber zeige auf das Paket
          cargo wix --release -p mapmap --no-check-includes
          $MsiPath = Get-ChildItem -Path "target/wix/*.msi" | Select-Object -First 1 -ExpandProperty FullName
          Move-Item -Path $MsiPath -Destination "MapFlow-${{ inputs.version }}-x64.msi"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            MapFlow-${{ inputs.version }}-Windows-x64.zip
            MapFlow-${{ inputs.version }}-x64.msi

  # ═══════════════════════════════════════════════════════════════
  # BUILD LINUX (TAR.GZ)
  # ═══════════════════════════════════════════════════════════════
  build-linux:
    name: "Build (Linux x64)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install System Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential pkg-config clang libclang-dev \
            libasound2-dev libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libavdevice-dev libavfilter-dev libswresample-dev \
            libudev-dev libx11-dev libxcursor-dev libxi-dev libxrandr-dev \
            libxinerama-dev libwayland-dev libxkbcommon-dev libssl-dev \
            ffmpeg

      - name: Build (Release)
        run: cargo build --release -p mapmap --features "audio,ffmpeg"

      - name: Create Tarball
        run: |
          VERSION="${{ inputs.version }}"
          TAR_NAME="MapFlow-$VERSION-Linux-x64.tar.gz"
          cd target/release
          # In einem Workspace-Build liegt das Binary direkt in target/release
          tar -czf "../../$TAR_NAME" MapFlow
          echo "TAR_PATH=$TAR_NAME" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: MapFlow-${{ inputs.version }}-Linux-x64.tar.gz

  # ═══════════════════════════════════════════════════════════════
  # CREATE GITHUB RELEASE
  # ═══════════════════════════════════════════════════════════════
  publish-release:
    name: "Publish Release"
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ inputs.is_prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "${{ inputs.version }}" \
            --title "MapFlow ${{ inputs.version }}" \
            --generate-notes \
            $PRERELEASE_FLAG \
            MapFlow-${{ inputs.version }}-Windows-x64.zip \
            MapFlow-${{ inputs.version }}-x64.msi \
            MapFlow-${{ inputs.version }}-Linux-x64.tar.gz
